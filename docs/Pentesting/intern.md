---
layout: default
title: Atac intern.
parent: Pentesting
nav_order: 2
---

# Assumim que algú ha entrat

## Anàlisi de ports i serveis

Anem a simular que algún atacant ha aconseguit accés a la màquina Docker Worker 2, que està a la xarxa OPT3 i té una direcció 192.168.1.31. La màquina ha estat compromesa i l'atacant ha obtingut accés al compte de superusuari ja que la meva contrassenya no era massa segura.

## Fingerprinting

Executarem ```cat /etc/*-release``` i ```uname -a``` per a conéixer detalls sobre el sistema vulnerable.

```bash
[admin@worker2 ~]$ uname -a
Linux worker2.espardenya.local 5.18.16-200.fc36.x86_64 #1 SMP PREEMPT_DYNAMIC Wed Aug 3 15:44:49 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux
[admin@worker2 ~]$ cat /etc/*-release
Fedora release 36 (Thirty Six)
NAME="Fedora Linux"
VERSION="36.20220806.3.0 (CoreOS)"
ID=fedora
VERSION_ID=36
VERSION_CODENAME=""
PLATFORM_ID="platform:f36"
PRETTY_NAME="Fedora CoreOS 36.20220806.3.0"
ANSI_COLOR="0;38;2;60;110;180"
LOGO=fedora-logo-icon
CPE_NAME="cpe:/o:fedoraproject:fedora:36"
HOME_URL="https://getfedora.org/coreos/"
DOCUMENTATION_URL="https://docs.fedoraproject.org/en-US/fedora-coreos/"
SUPPORT_URL="https://github.com/coreos/fedora-coreos-tracker/"
BUG_REPORT_URL="https://github.com/coreos/fedora-coreos-tracker/"
REDHAT_BUGZILLA_PRODUCT="Fedora"
REDHAT_BUGZILLA_PRODUCT_VERSION=36
REDHAT_SUPPORT_PRODUCT="Fedora"
REDHAT_SUPPORT_PRODUCT_VERSION=36
PRIVACY_POLICY_URL="https://fedoraproject.org/wiki/Legal:PrivacyPolicy"
VARIANT="CoreOS"
VARIANT_ID=coreos
OSTREE_VERSION='36.20220806.3.0'
DEFAULT_HOSTNAME=localhost
Fedora release 36 (Thirty Six)
Fedora release 36 (Thirty Six)
```

L'atacant ha obtingut privilegis elevats, així que pot procedir a instal·lar nmap.

```bash
rpm-ostree install nmap
```

Podem buscar els nodes a la xarxa del clúster.

```Ps
[admin@worker2 ~]$ nmap -sP 192.168.1.1/24
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-04 16:51 UTC
Nmap scan report for 192.168.1.10
Host is up (0.0014s latency).
Nmap scan report for 192.168.1.20
Host is up (0.0021s latency).
Nmap scan report for 192.168.1.21
Host is up (0.0021s latency).
Nmap scan report for 192.168.1.30
Host is up (0.0019s latency).
Nmap scan report for worker2.espardenya.local (192.168.1.31)
Host is up (0.00097s latency).
Nmap done: 256 IP addresses (5 hosts up) scanned in 16.04 seconds
```
I escanejar els serveis i les versions.

```bash
# -O ens treu el sistema operatiu i -sV els serveis i les versions.
[admin@worker2 ~]$ sudo nmap -O -sV 192.168.1.1/24
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-04 16:53 UTC
Nmap scan report for 192.168.1.10
Host is up (0.00045s latency).
Not shown: 995 closed tcp ports (reset)
PORT     STATE SERVICE   VERSION
22/tcp   open  ssh       OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
80/tcp   open  http      Caddy httpd
111/tcp  open  rpcbind   2-4 (RPC #100000)
443/tcp  open  ssl/https
2049/tcp open  nfs_acl   3 (RPC #100227)
MAC Address: 92:12:42:6E:36:FD (Unknown)
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.6
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Nmap scan report for 192.168.1.20
Host is up (0.00044s latency).
Not shown: 999 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.8 (protocol 2.0)
MAC Address: A2:17:38:BA:31:57 (Unknown)
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.6
Network Distance: 1 hop

Nmap scan report for 192.168.1.21
Host is up (0.00039s latency).
Not shown: 999 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.8 (protocol 2.0)
MAC Address: 32:1A:52:E4:BC:48 (Unknown)
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.92%E=4%D=9/4%OT=22%CT=1%CU=30323%PV=Y%DS=1%DC=D%G=Y%M=321A52%TM
OS:=6314D844%P=x86_64-redhat-linux-gnu)SEQ(SP=F6%GCD=1%ISR=FD%TI=Z%CI=Z%TS=
OS:A)SEQ(SP=F6%GCD=1%ISR=FD%TI=Z%CI=Z%II=I%TS=A)OPS(O1=M5B4ST11NW7%O2=M5B4S
OS:T11NW7%O3=M5B4NNT11NW7%O4=M5B4ST11NW7%O5=M5B4ST11NW7%O6=M5B4ST11)WIN(W1=
OS:FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)ECN(R=Y%DF=Y%T=40%W=FAF0%O=
OS:M5B4NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)
OS:T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=40%W=0%S=Z%A=S
OS:+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T7(R=Y%DF=
OS:Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=40%IPL=164%UN=0%RIPL=G
OS:%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD=S)

Network Distance: 1 hop

Nmap scan report for 192.168.1.30
Host is up (0.00039s latency).
Not shown: 999 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.8 (protocol 2.0)
MAC Address: EA:58:42:BB:7D:CA (Unknown)
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.6
Network Distance: 1 hop

Nmap scan report for worker2.espardenya.local (192.168.1.31)
Host is up (0.000051s latency).
Not shown: 998 closed tcp ports (reset)
PORT     STATE    SERVICE  VERSION
22/tcp   open     ssh      OpenSSH 8.8 (protocol 2.0)
3005/tcp filtered deslogin
Device type: general purpose
Running: Linux 2.6.X
OS CPE: cpe:/o:linux:linux_kernel:2.6.32
OS details: Linux 2.6.32
Network Distance: 0 hops

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 256 IP addresses (5 hosts up) scanned in 36.38 seconds
```

## Vulnerabilitats detectades.

Podem veure que la màquina 192.168.1.10 té obert el port 111, que correspon al protocol RCP bind. Anem a treure informació escanejant el port 111 d'aquella màquina. 

Com que l'atacant està dins de la nostra xarxa, pot emprar un escaneig Syn per a 

```bash
# La combinació d'arguments -sS i -sU (-sSUC) escanejaran tots els ports en ambdós protocols.
[admin@worker2 ~]$ sudo nmap -sSUC -p 111 192.168.1.10
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-04 17:00 UTC
Nmap scan report for 192.168.1.10
Host is up (0.00078s latency).

PORT    STATE SERVICE
111/tcp open  rpcbind
| rpcinfo:
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3           2049/udp   nfs
|   100003  3           2049/udp6  nfs
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
|   100005  1,2,3      40497/udp   mountd
|   100005  1,2,3      52091/tcp6  mountd
|   100005  1,2,3      54233/tcp   mountd
|   100005  1,2,3      60100/udp6  mountd
|   100021  1,3,4      38935/tcp   nlockmgr
|   100021  1,3,4      40016/udp   nlockmgr
|   100021  1,3,4      41697/tcp6  nlockmgr
|   100021  1,3,4      41698/udp6  nlockmgr
|   100227  3           2049/tcp   nfs_acl
|   100227  3           2049/tcp6  nfs_acl
|   100227  3           2049/udp   nfs_acl
|_  100227  3           2049/udp6  nfs_acl
111/udp open  rpcbind
| rpcinfo:
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3           2049/udp   nfs
|   100003  3           2049/udp6  nfs
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
|   100005  1,2,3      40497/udp   mountd
|   100005  1,2,3      52091/tcp6  mountd
|   100005  1,2,3      54233/tcp   mountd
|   100005  1,2,3      60100/udp6  mountd
Nmap done: 1 IP address (1 host up) scanned in 14.53 seconds
```

Podem veure que aquesta màquina serveix un NFS share. Anem a investigar si podem saber què està servint i a qui.

```PS
[admin@worker2 ~]$ nmap -p 111 --script=nfs-ls 192.168.1.10
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-04 17:37 UTC
Nmap scan report for 192.168.1.10
Host is up (0.0010s latency).

PORT    STATE SERVICE
111/tcp open  rpcbind

Nmap done: 1 IP address (1 host up) scanned in 0.39 seconds
[admin@worker2 ~]$ nmap -p 2049 --script=nfs-ls 192.168.1.10
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-04 17:37 UTC
Nmap scan report for 192.168.1.10
Host is up (0.00096s latency).

PORT     STATE SERVICE
2049/tcp open  nfs

Nmap done: 1 IP address (1 host up) scanned in 0.35 seconds
```

L'script nfs-ls no ens ha donat més informació de la que teníem, només ens ha confirmat que els ports estàn oberts i corresponen als serveis correctes.. Intentarem treure les carpetes compartides amb NFS-Showmount:
```PS
[admin@worker2 ~]$ nmap -p 2049 --script=nfs-showmount 192.168.1.10
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-04 17:38 UTC
Nmap scan report for 192.168.1.10
Host is up (0.00083s latency).

PORT     STATE SERVICE
2049/tcp open  nfs

Nmap done: 1 IP address (1 host up) scanned in 0.38 seconds
[admin@worker2 ~]$ nmap -p 111 --script=nfs-showmount 192.168.1.10
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-04 17:38 UTC
Nmap scan report for 192.168.1.10
Host is up (0.00084s latency).

PORT    STATE SERVICE
111/tcp open  rpcbind
| nfs-showmount:
|_  /home/plex *

Nmap done: 1 IP address (1 host up) scanned in 0.42 seconds
```

## Conculusió

Hem descobert que la carpeta /home/plex és una carpeta compartida. Podem comprovar amb un simple ```mount 192.168.1.10:/home/plex /mnt/home/plex``` si el nostre usuari i la nostra direcció IP té permisos per accedir al share, i comprovar que, en efecte, en tenim.

Si no en tenguéssim, podem investigar quins UID tenen permisos d'escriptura i crear un usuari local amb el mateix UID. Així, amb aquell usuari obtindríem permisos per a llegir i editar els fitxers.

Un cop obtinguts els permisos, és questió de temps que el servei estigui actiu. Hem obtingut accés a les configuracions, possibles bases de dades...
Un atacant podría facilment eliminar el servei o obtenir les dades sensibles que es troben guardades en el mateix.
