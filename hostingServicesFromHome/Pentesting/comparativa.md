---
layout: default
title: Desactivant el CDN
parent: Pentesting
grand_parent: Exposem serveis a Internet
nav_order: 1
---

# Comparativa: Deshabilitant el CDN de Cloudflare

Si desactivam des del panell de control el reverse proxy, ens podràn veure la IP i atacar directament el nostre Firewall. Anem a desactivar el reverse proxy per el domini arrel @.espardenya.me i evaluar-lo.
## Footprinting
Començarem fent un nslookup, tal com hem fet en l'apartat anterior. Podem veure com ara resoldrà a la nostra direcció IP.

```bash
@intern $ nslookup www.espardenya.me
Servidor:  hamm.espardenya.local
Address:  10.0.74.1

Respuesta no autoritativa:
Nombre:  www.espardenya.me
Address:  la-meva-ip-pública
```

Podem fer un escaneig amb Nmap per a  confirmar que el host està operatiu.

```bash
# L'atribut -sP ens intentarà treure informació sobre la xarxa i el tipus de sistema, i l'atribut -Pn ens treurà informació sobre els ports oberts quan no és accessible el host.
@intern $ nmap -sP -Pn la-meva-ip-pública
Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-04 17:09 CEST
Nmap scan report for ip (la-meva-ip-pública)
Host is up.
Nmap done: 1 IP address (1 host up) scanned in 0.78 seconds
```

Executant de manera interna ```nmap -Pn la-meva-ip-pública``` ens dona el seguent resultat

```bash
@intern $ nmap -Pn la-meva-ip-pública
Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-04 17:16 CEST
Nmap scan report for ip (la-meva-ip-pública)
Host is up (0.0068s latency).
Not shown: 997 filtered tcp ports (no-response)
PORT    STATE SERVICE
53/tcp  open  domain
80/tcp  open  http
443/tcp open  https

Nmap done: 1 IP address (1 host up) scanned in 5.13 seconds
```

Però, de manera externa, no obtindrem res. 

```bash
@extern $ nmap -Pn la-meva-ip-pública
Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-04 17:16 CEST
Nmap scan report for ip (la-meva-ip-pública)
Host is up.
All 1000 scanned ports on ip (la-meva-ip-pública) are in ignored states.
Not shown: 1000 filtered tcp ports (no-response)

Nmap done: 1 IP address (1 host up) scanned in 201.63 seconds
```

Anem a deshabilitar el filtratge de ports. A partir d'ara, qualsevol IP pot connectar al port 443 del nostre firewall, no només des de Cloudflare.

<img src="..\assets\images\pentesting\direct\deshabilitarfiltre.png" alt="Bloqueig direccions IP Suricata " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>

Anem a escanejar altre cop a veure si canvia el resultat.
```bash
@extern $ nmap -Pn la-meva-ip-pública
Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-04 17:24 CEST
Nmap scan report for la-meva-ip-pública (la-meva-ip-pública)
Host is up (0.067s latency).
Not shown: 999 filtered tcp ports (no-response)
PORT    STATE SERVICE
443/tcp open  https

Nmap done: 1 IP address (1 host up) scanned in 146.21 seconds
```

> Nota: Podem veure com un escaneig extern tarda molt més que un escaneig intern.

## Fingerprinting

Els resultats de [Pentest-Tools](https://pentest-tools.com) són una mica més curiosos. Per començar, ens dona dos errors deguts als certificats SSL propis de Cloudflare, ja que no són reconeguts si no accedim a través del CDN.

<img src="..\assets\images\pentesting\direct\ssl_errors.png" alt="Bloqueig direccions IP Suricata " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>

Després, ens detecta Caddy com a servidor, però no ens detecta ni versió ni més dades, ja que les varem protegir.

<img src="..\assets\images\pentesting\direct\caddy.png" alt="Bloqueig direccions IP Suricata " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>

Les demés dades són les mateixes.

<img src="..\assets\images\pentesting\direct\resultatanalisis.png" alt="Bloqueig direccions IP Suricata " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>

## Explotació

Anem a provar amb un atac Slow Loris un altre pic, ara directament al servidor. Començarem amb 150 sockets.

### Slowloris - 150 Sockets.

L'atac Slowloris de 150 sockets ha estat bloquejat de manera bastant efectiva. Podem veure que s'ha bloquejat l'atac de manera bastant efectiva i no s'ha vist alterat el servei.
```bash
@extern $ python3 slowloris.py plex.espardenya.me        
[04-08-2022 18:06:27] Attacking plex.espardenya.me with 150 sockets.
[04-08-2022 18:06:27] Creating sockets...
[04-08-2022 18:06:36] Sending keep-alive headers... Socket count: 150
[04-08-2022 18:06:51] Sending keep-alive headers... Socket count: 150
[04-08-2022 18:07:10] Sending keep-alive headers... Socket count: 0
[04-08-2022 18:07:29] Sending keep-alive headers... Socket count: 0
[04-08-2022 18:07:48] Sending keep-alive headers... Socket count: 0
[04-08-2022 18:08:07] Sending keep-alive headers... Socket count: 0
```

El tràfic del Firewall ha detectat una pujada sobtada, ja que Suricata bloqueja amb el mode Legacy.

<img src="..\assets\images\pentesting\direct\pico_slowloris_150.png" alt="Bloqueig direccions IP Suricata " width="700" style="display: block; margin-left: auto; margin-right: auto; margin-bottom: 12px;"/>


> #### Apunt: Mode Legacy o Mode Inline de Suricata 
> El mode Inline de suricata és capaç de detectar els atacs al moment, ja que analitza els paquets alhora que van entrant. En canvi, el mode Legacy tarda una mica més així gastant molts menys recursos. Com que el meu hardware és limitat, estic emprant el mode Legacy, per això veim el registre, ja que l'atac ha tingut una petita finestra per a actuar.

### Slowloris - 5000 Sockets.

Per a fer aquesta prova després del bloqueig de la prova anterior, hem canviat la IP.

```bash
@extern $ python3 slowloris.py plex.espardenya.me -s 5000
[04-08-2022 18:29:27] Attacking plex.espardenya.me with 5000 sockets.
[04-08-2022 18:29:27] Creating sockets...
[04-08-2022 18:29:31] Sending keep-alive headers... Socket count: 0
[04-08-2022 18:29:51] Sending keep-alive headers... Socket count: 0
[04-08-2022 18:30:10] Sending keep-alive headers... Socket count: 0
[04-08-2022 18:30:31] Sending keep-alive headers... Socket count: 0
[04-08-2022 18:30:50] Sending keep-alive headers... Socket count: 0
```

<img src="..\assets\images\pentesting\direct\pico_slowloris_5000.png" alt="Bloqueig direccions IP Suricata " width="700" style="display: block; margin-left: auto; margin-right: auto; margin-bottom: 12px;"/>

S'ha bloquejat a la primera. Ha passat el mateix, una pujada de tràfic sobtada i s'ha bloquejat el tràfic.

## Conclusió

El Firewall ha bloquejat de manera bastant efectiva els atacs de denegació de servei slowloris. Encara que, per limitacions del hardware, han tingut una finestra de temps per actuar.

És notable destacar que hem obtingut dades més precises atacant directament el Firewall en comptes del CDN.